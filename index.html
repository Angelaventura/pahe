<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Las 48 Leyes del Poder - Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Notion-style custom properties */
    :root {
      --notion-gray-50: #f7f7f5;
      --notion-gray-100: #ebebea;
      --notion-gray-200: #e0e0de;
      --notion-gray-300: #d1d0ce;
      --notion-gray-400: #b8b7b5;
      --notion-gray-500: #a5a4a2;
      --notion-gray-600: #888782;
      --notion-gray-700: #6e6d6a;
      --notion-gray-800: #565653;
      --notion-gray-900: #3f3f3c;
      --notion-blue: #0969da;
      --notion-blue-light: #dbeafe;
      --notion-border: #e9e9e7;
      --notion-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --notion-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Dark mode specific properties */
    html.dark {
      --notion-gray-50: #2f2f2f;
      --notion-gray-100: #383838;
      --notion-gray-200: #404040;
      --notion-gray-300: #4a4a4a;
      --notion-gray-400: #666666;
      --notion-gray-500: #7a7a7a;
      --notion-gray-600: #9b9b9b;
      --notion-gray-700: #b8b8b8;
      --notion-gray-800: #d1d1d1;
      --notion-gray-900: #e6e6e6;
      --notion-blue: #5b9bd5;
      --notion-border: #404040;
      --notion-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--notion-gray-50);
      color: var(--notion-gray-900);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      font-size: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
    }

    .widget-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0.5rem;
      background-color: transparent;
    }

    .widget-card {
      background: white;
      border-radius: 8px;
      border: 1px solid var(--notion-border);
      box-shadow: var(--notion-shadow);
      overflow: hidden;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition */
    }

    /* Adjust background and border for dark mode */
    html.dark .widget-card {
        background: #2f2f2f;
        border-color: var(--notion-border);
    }

    .widget-header {
      padding: 1rem;
      border-bottom: 1px solid var(--notion-border);
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .widget-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.25rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .widget-subtitle {
      font-size: 0.75rem;
      opacity: 0.9;
      margin: 0;
    }

    .widget-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .generate-section {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--notion-border);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .info-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--notion-gray-100);
      border: 1px solid var(--notion-border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      color: var(--notion-gray-700);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease; /* Smooth transition */
    }

    /* Adjust info-display for dark mode */
    html.dark .info-display {
        background: var(--notion-gray-200);
        border-color: var(--notion-border);
        color: var(--notion-gray-700);
    }

    .weather-info-stack {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .weather-recommendation {
      font-size: 0.65rem;
      color: var(--notion-gray-600);
      margin-top: 0.2rem;
    }

    .generate-button {
      background: var(--notion-blue);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin: 0 auto;
    }

    .generate-button:hover:not(:disabled) {
      background: #0757c7;
      transform: translateY(-1px);
    }

    .generate-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--notion-gray-600);
      flex: 1;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--notion-gray-200);
      border-top: 2px solid var(--notion-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .carousel-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
      height: 100%;
    }

    .carousel-slide {
      min-width: 100%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .slide-header {
      text-align: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--notion-border);
      transition: border-color 0.3s ease; /* Smooth transition */
    }

    .slide-number {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--notion-blue);
      margin: 0 0 0.25rem 0;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .slide-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--notion-gray-900);
      margin: 0;
      line-height: 1.3;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .slide-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--notion-gray-900);
      margin: 0 0 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .section-text {
      font-size: 0.75rem;
      color: var(--notion-gray-700);
      line-height: 1.5;
      margin: 0;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .section-text.italic {
      font-style: italic;
      color: var(--notion-gray-600);
      transition: color 0.3s ease; /* Smooth transition */
    }

    .section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .section-list li {
      position: relative;
      padding-left: 1rem;
      margin-bottom: 0.25rem;
      font-size: 0.75rem;
      color: var(--notion-gray-700);
      line-height: 1.4;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .section-list li::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: var(--notion-blue);
      font-weight: bold;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .carousel-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--notion-border);
      background: var(--notion-gray-50);
      transition: background 0.3s ease, border-color 0.3s ease; /* Smooth transition */
    }

    .nav-button {
      background: white;
      border: 1px solid var(--notion-border);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease, background 0.3s ease, border-color 0.3s ease, color 0.3s ease; /* Smooth transition */
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      color: var(--notion-gray-700);
    }

    .nav-button:hover:not(:disabled) {
      background: var(--notion-gray-100);
      transform: translateY(-1px);
    }
    html.dark .nav-button {
      background: var(--notion-gray-200);
      border-color: var(--notion-border);
      color: var(--notion-gray-700);
    }
    html.dark .nav-button:hover:not(:disabled) {
      background: var(--notion-gray-300);
    }


    .nav-button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .carousel-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--notion-gray-600);
      transition: color 0.3s ease; /* Smooth transition */
    }

    .indicator-dots {
      display: flex;
      gap: 0.25rem;
    }

    .indicator-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--notion-gray-300);
      transition: background 0.2s ease;
    }

    .indicator-dot.active {
      background: var(--notion-blue);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--notion-gray-500);
      text-align: center;
      flex: 1;
      transition: color 0.3s ease; /* Smooth transition */
    }

    .empty-state-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .empty-state-text {
      font-size: 0.75rem;
      margin: 0;
    }

    /* Styles for the theme toggle button */
    .theme-toggle-button {
      background: var(--notion-gray-100);
      border: 1px solid var(--notion-border);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease, background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem; /* Make it smaller */
      color: var(--notion-gray-700);
      width: 36px; /* Ensure it's a small, square button */
      height: 36px;
      position: relative; /* For tooltip positioning */
    }

    .theme-toggle-button:hover {
      background: var(--notion-gray-200);
      transform: translateY(-1px);
    }

    html.dark .theme-toggle-button {
      background: var(--notion-gray-200);
      border-color: var(--notion-border);
      color: var(--notion-gray-700);
    }

    html.dark .theme-toggle-button:hover {
      background: var(--notion-gray-300);
    }
    .theme-toggle-tooltip {
        position: absolute;
        bottom: calc(100% + 5px); /* Position above the button */
        left: 50%;
        transform: translateX(-50%);
        background: var(--notion-gray-800);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.65rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        pointer-events: none; /* Allows clicks to pass through to the button */
        z-index: 10;
    }

    .theme-toggle-button:hover .theme-toggle-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Styles for Pomodoro Button and Dropdown */
    .pomodoro-container {
        position: relative;
        display: inline-block;
    }

    .pomodoro-button {
      background: #f0f0f0; /* Light grey, can be customized */
      border: 1px solid var(--notion-border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease, background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: var(--notion-gray-700);
      position: relative; /* Needed for dropdown positioning */
      z-index: 20; /* Above dropdown */
    }
    .pomodoro-button:hover:not(:disabled) {
      background: var(--notion-gray-200);
      transform: translateY(-1px);
    }
    .pomodoro-button.active {
      background: var(--notion-blue);
      color: white;
      border-color: var(--notion-blue);
    }
    .pomodoro-button.active:hover {
        background: #0757c7;
    }
    html.dark .pomodoro-button {
        background: var(--notion-gray-200);
        border-color: var(--notion-border);
        color: var(--notion-gray-700);
    }
    html.dark .pomodoro-button:hover:not(:disabled) {
        background: var(--notion-gray-300);
    }
    html.dark .pomodoro-button.active {
        background: var(--notion-blue);
        border-color: var(--notion-blue);
        color: white;
    }

    .pomodoro-dropdown {
        position: absolute;
        top: 100%; /* Position below the button */
        left: 0;
        margin-top: 5px;
        background: white;
        border: 1px solid var(--notion-border);
        border-radius: 6px;
        box-shadow: var(--notion-shadow);
        z-index: 10;
        min-width: 120px; /* Adjust as needed */
        overflow: hidden;
        transition: opacity 0.2s ease, transform 0.2s ease;
        transform-origin: top;
        opacity: 0;
        transform: translateY(-5px);
        pointer-events: none; /* Don't block clicks when hidden */
    }

    .pomodoro-dropdown.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    html.dark .pomodoro-dropdown {
        background: #383838;
        border-color: var(--notion-border);
    }

    .pomodoro-dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--notion-gray-700);
        transition: background-color 0.15s ease, color 0.15s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pomodoro-dropdown-item:hover {
        background-color: var(--notion-gray-100);
        color: var(--notion-gray-900);
    }
    html.dark .pomodoro-dropdown-item:hover {
        background-color: var(--notion-gray-400);
        color: var(--notion-gray-900);
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .widget-container {
        padding: 0.25rem;
      }
      
      .carousel-slide {
        padding: 0.75rem;
      }
      
      .slide-title {
        font-size: 0.875rem;
      }
      
      .section-text {
        font-size: 0.7rem;
      }

      .generate-section {
        flex-direction: column;
        gap: 0.75rem;
      }
      .theme-toggle-button {
          width: 32px;
          height: 32px;
          padding: 0.4rem;
          font-size: 0.7rem;
      }
      .pomodoro-button {
          padding: 0.5rem 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="widget-card">

      <div class="widget-content">
        <div class="generate-section">
          <div class="info-display">
            <span>‚è∞</span>
            <span id="currentTime"></span>
          </div>
          <button id="themeToggleBtn" class="theme-toggle-button" aria-label="Toggle light and dark mode">
              <span id="themeToggleIcon">‚òÄÔ∏è</span>
              <span id="themeToggleTooltip" class="theme-toggle-tooltip">Cambiar a modo oscuro</span>
          </button>
          <div class="pomodoro-container">
            <button id="pomodoroBtn" class="pomodoro-button">
              <span id="pomodoroIcon">‚ñ∂Ô∏è</span>
              <span id="pomodoroDisplay">25:00</span>
            </button>
            <div id="pomodoroDropdown" class="pomodoro-dropdown">
                <div class="pomodoro-dropdown-item" data-minutes="5">
                    <span>‚è±Ô∏è</span>
                    <span>5 Minutos</span>
                </div>
                <div class="pomodoro-dropdown-item" data-minutes="15">
                    <span>‚è±Ô∏è</span>
                    <span>15 Minutos</span>
                </div>
                <div class="pomodoro-dropdown-item" data-minutes="30">
                    <span>‚è±Ô∏è</span>
                    <span>30 Minutos</span>
                </div>
                <hr style="border-color: var(--notion-border); margin: 0 0.5rem;">
                <div class="pomodoro-dropdown-item" id="pomodoroResetItem">
                    <span>üîÑ</span>
                    <span>Reiniciar</span>
                </div>
            </div>
          </div>
          <button onclick="displayLaw()" class="generate-button" id="generate-law-btn">
            <span>‚ú®</span>
            <span>Nueva Ley</span>
          </button>
          <div class="info-display">
            <span id="weatherIcon">‚òÄÔ∏è</span>
            <div class="weather-info-stack">
              <span id="weatherText">Cargando clima...</span>
              <span id="weatherRecommendation" class="weather-recommendation"></span>
            </div>
          </div>
        </div>

        <div id="loadingIndicator" class="loading-state hidden">
          <div class="spinner"></div>
          <p style="font-size: 0.75rem; margin: 0;">Generando...</p>
        </div>

        <div id="emptyState" class="empty-state">
          <div class="empty-state-icon">üéØ</div>
          <p class="empty-state-text">Haz clic para revelar una ley del poder</p>
        </div>

        <div id="carouselContainer" class="carousel-container hidden">
          <div class="carousel-track" id="carouselTrack">
            </div>
        </div>

        <div id="carouselNav" class="carousel-nav hidden">
          <button class="nav-button" id="prevBtn" onclick="previousSlide()">‚Üê</button>
          <div class="carousel-indicator">
            <span id="slideCounter">1 / 11</span>
            <div class="indicator-dots" id="indicatorDots"></div>
          </div>
          <button class="nav-button" id="nextBtn" onclick="nextSlide()">‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSlide = 0;
    let totalSlides = 0;
    let lawData = null;
    let isDarkMode = false; // Track current theme state

    // OpenWeatherMap API Key for weather data in Zapopan, Jalisco
    const OPENWEATHER_API_KEY = "11764e38b80fc8ed77ee385e08a3d3d5"; 
    const CITY = "Zapopan";
    const COUNTRY_CODE = "MX";
    const UNITS = "metric"; // Use 'metric' for Celsius, 'imperial' for Fahrenheit

    const slides = [
      { key: 'fable', title: 'F√°bula', icon: 'üìñ' }, // Now starts with Fable
      { key: 'illustrativeHistory', title: 'Historia Ilustrativa', icon: 'üèõÔ∏è' },
      { key: 'lesson', title: 'Lecci√≥n Principal', icon: 'üí°' },
      { key: 'example', title: 'Ejemplo Contempor√°neo', icon: 'üåü' },
      { key: 'invalidation', title: 'Cu√°ndo No Aplicar', icon: '‚ö†Ô∏è' },
      { key: 'imageDescription', title: 'S√≠mbolo Visual', icon: 'üé®' },
      { key: 'keys', title: 'Claves del Poder', icon: 'üîë' },
      { key: 'psychologicalInterpretation', title: 'Interpretaci√≥n Psicol√≥gica', icon: 'üß†' },
      { key: 'practicalObservance', title: 'Aplicaci√≥n Pr√°ctica', icon: 'üéØ' },
      { key: 'psychologicalFoundations', title: 'Fundamentos Psicol√≥gicos', icon: 'üî¨' },
      { key: 'conclusion', title: 'Conclusi√≥n', icon: 'üí≠' }
    ];

    async function fetchRandomLaw() {
        let chatHistory = [];
        const prompt = `Genera una ley aleatoria de "Las 48 Leyes del Poder" con todos los siguientes campos en formato JSON, en espa√±ol. Aseg√∫rate de que el 'number' sea un n√∫mero entero entre 1 y 48. Los campos son:
        - number (n√∫mero de la ley)
        - name (nombre de la ley)
        - fable (f√°bula)
        - illustrativeHistory (historia ilustrativa)
        - lesson (lecci√≥n principal)
        - example (ejemplo actual o contempor√°neo)
        - invalidation (cu√°ndo no aplicar la ley)
        - imageDescription (descripci√≥n sugerida para una imagen o s√≠mbolo visual)
        - keys (claves para alcanzar el poder, una lista de strings)
        - psychologicalInterpretation (interpretaci√≥n psicol√≥gica)
        - practicalObservance (observancia pr√°ctica, d√≥nde se aplica, una lista de strings)
        - psychologicalFoundations (fundamentos psicol√≥gicos)
        - conclusion (conclusi√≥n breve o cierre)`;

        chatHistory.push({ role: "user", parts: [{ text: prompt }] });

        const payload = {
            contents: chatHistory,
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "number": { "type": "NUMBER" },
                        "name": { "type": "STRING" },
                        "fable": { "type": "STRING" },
                        "illustrativeHistory": { "type": "STRING" },
                        "lesson": { "type": "STRING" },
                        "example": { "type": "STRING" },
                        "invalidation": { "type": "STRING" },
                        "imageDescription": { "type": "STRING" },
                        "keys": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "psychologicalInterpretation": { "type": "STRING" },
                        "practicalObservance": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "psychologicalFoundations": { "type": "STRING" },
                        "conclusion": { "type": "STRING" }
                    },
                    "required": [
                        "number", "name", "fable", "illustrativeHistory", "lesson", "example", "invalidation",
                        "imageDescription", "keys", "psychologicalInterpretation",
                        "practicalObservance", "psychologicalFoundations", "conclusion"
                    ]
                }
            }
        };

        const apiKey = "AIzaSyCOIkKdI9IvOdQq5ReRK6YW00lMXkc37Xc";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        } else {
            throw new Error("No se pudo generar la ley.");
        }
    }

    function createSlideContent(slide, data) {
        const slideDiv = document.createElement('div');
        slideDiv.className = 'carousel-slide';

        if (slide.key === 'keys' || slide.key === 'practicalObservance') {
            const items = data[slide.key];
            let listHtml = '';
            if (items && Array.isArray(items)) {
                items.forEach(item => {
                    listHtml += `<li>${item}</li>`;
                });
            }
            slideDiv.innerHTML = `
                <div class="slide-header">
                    <h2 class="slide-number">Ley #${data.number}</h2>
                    <h3 class="slide-title">${data.name}</h3>
                </div>
                <div class="slide-content">
                    <div class="section-title">
                        <span>${slide.icon}</span>
                        <span>${slide.title}</span>
                    </div>
                    <ul class="section-list">${listHtml}</ul>
                </div>
            `;
        } else if (slide.key === 'imageDescription') {
            slideDiv.innerHTML = `
                <div class="slide-header">
                    <h2 class="slide-number">Ley #${data.number}</h2>
                    <h3 class="slide-title">${data.name}</h3>
                </div>
                <div class="slide-content">
                    <div class="section-title">
                        <span>${slide.icon}</span>
                        <span>${slide.title}</span>
                    </div>
                    <p class="section-text italic">${data[slide.key]}</p>
                </div>
            `;
        } else {
            slideDiv.innerHTML = `
                <div class="slide-header">
                    <h2 class="slide-number">Ley #${data.number}</h2>
                    <h3 class="slide-title">${data.name}</h3>
                </div>
                <div class="slide-content">
                    <div class="section-title">
                        <span>${slide.icon}</span>
                        <span>${slide.title}</span>
                    </div>
                    <p class="section-text">${data[slide.key]}</p>
                </div>
            `;
        }

        return slideDiv;
    }

    function createCarousel(data) {
        const track = document.getElementById('carouselTrack');
        const dotsContainer = document.getElementById('indicatorDots');
        
        track.innerHTML = '';
        dotsContainer.innerHTML = '';

        slides.forEach((slide, index) => {
            const slideElement = createSlideContent(slide, data);
            track.appendChild(slideElement);

            const dot = document.createElement('div');
            dot.className = `indicator-dot ${index === 0 ? 'active' : ''}`;
            dotsContainer.appendChild(dot);
        });

        totalSlides = slides.length;
        currentSlide = 0;
        updateCarousel();
    }

    function updateCarousel() {
        const track = document.getElementById('carouselTrack');
        const counter = document.getElementById('slideCounter');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const dots = document.querySelectorAll('.indicator-dot');

        track.style.transform = `translateX(-${currentSlide * 100}%)`;
        counter.textContent = `${currentSlide + 1} / ${totalSlides}`;

        prevBtn.disabled = currentSlide === 0;
        nextBtn.disabled = currentSlide === totalSlides - 1;

        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentSlide);
        });
    }

    function nextSlide() {
        if (currentSlide < totalSlides - 1) {
            currentSlide++;
            updateCarousel();
        }
    }

    function previousSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            updateCarousel();
        }
    }

    async function displayLaw() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');
        const carouselContainer = document.getElementById('carouselContainer');
        const carouselNav = document.getElementById('carouselNav');
        const generateButton = document.getElementById('generate-law-btn');

        try {
            loadingIndicator.classList.remove('hidden');
            emptyState.classList.add('hidden');
            carouselContainer.classList.add('hidden');
            carouselNav.classList.add('hidden');
            generateButton.disabled = true;

            const law = await fetchRandomLaw();
            lawData = law;

            createCarousel(law);

            carouselContainer.classList.remove('hidden');
            carouselNav.classList.remove('hidden');

        } catch (error) {
            console.error("Error:", error);
            emptyState.innerHTML = `
                <div class="empty-state-icon">‚ùå</div>
                <p class="empty-state-text">Error al cargar. Int√©ntalo de nuevo.</p>
            `;
            emptyState.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
            generateButton.disabled = false;
        }
    }

    // Clock functionality
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('currentTime').textContent = timeString;
    }

    // Function to get clothing/accessory recommendations
    function getWeatherRecommendation(temp, description, iconCode) {
        let recommendations = [];

        if (temp < 10) {
            recommendations.push("üß• Abrigo pesado");
        } else if (temp >= 10 && temp < 18) {
            recommendations.push("üß£ Su√©ter o chaqueta");
        } else if (temp >= 18 && temp < 25) {
            recommendations.push("üëï Chaqueta ligera");
        } else {
            recommendations.push("üëö Ropa ligera");
        }

        if (iconCode.includes('09') || iconCode.includes('10') || iconCode.includes('11')) {
            recommendations.push("‚òî Lleva paraguas");
        }
        if (iconCode.includes('13')) {
            recommendations.push("üß§ Gorro y guantes");
        }
        if ((iconCode.includes('01') || iconCode.includes('02')) && temp > 20) {
            recommendations.push("üï∂Ô∏è Gafas de sol");
        }
        if (iconCode.includes('01') && temp > 25) {
            recommendations.push("üß¢ Gorra y üß¥ protector solar");
        }
        if (iconCode.includes('50')) {
            recommendations.push("üöó Ten precauci√≥n al conducir");
        }

        return recommendations.join(" y ") + ".";
    }

    // Weather functionality
    async function fetchWeather() {
        const weatherIcon = document.getElementById('weatherIcon');
        const weatherText = document.getElementById('weatherText');
        const weatherRecommendation = document.getElementById('weatherRecommendation');

        if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === "TU_CLAVE_API_DE_OPENWEATHERMAP") {
            weatherText.textContent = "Clave API de clima no configurada.";
            weatherRecommendation.textContent = "";
            weatherIcon.textContent = "‚ö†Ô∏è";
            return;
        }

        try {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${CITY},${COUNTRY_CODE}&appid=${OPENWEATHER_API_KEY}&units=${UNITS}&lang=es`);
            const data = await response.json();

            if (data.cod === 200) {
                const temp = Math.round(data.main.temp);
                const description = data.weather[0].description;
                const iconCode = data.weather[0].icon;
                
                let emojiIcon = '‚ùì';
                if (iconCode.includes('01')) emojiIcon = '‚òÄÔ∏è';
                else if (iconCode.includes('02')) emojiIcon = 'üå§Ô∏è';
                else if (iconCode.includes('03') || iconCode.includes('04')) emojiIcon = '‚òÅÔ∏è';
                else if (iconCode.includes('09') || iconCode.includes('10')) emojiIcon = 'üåßÔ∏è';
                else if (iconCode.includes('11')) emojiIcon = '‚õàÔ∏è';
                else if (iconCode.includes('13')) emojiIcon = '‚ùÑÔ∏è';
                else if (iconCode.includes('50')) emojiIcon = 'üå´Ô∏è';

                weatherIcon.textContent = emojiIcon;
                weatherText.textContent = `${temp}¬∞C, ${description}.`;
                weatherRecommendation.textContent = getWeatherRecommendation(temp, description, iconCode);

            } else {
                weatherIcon.textContent = "‚ùå";
                weatherText.textContent = `Error: ${data.message}`;
                weatherRecommendation.textContent = "";
            }
        } catch (error) {
            console.error("Error al obtener el clima:", error);
            weatherIcon.textContent = "‚ùó";
            weatherText.textContent = "Error al obtener el clima.";
            weatherRecommendation.textContent = "";
        }
    }

    // --- Theme Toggle Logic ---
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeToggleIcon = document.getElementById('themeToggleIcon');
    const themeToggleTooltip = document.getElementById('themeToggleTooltip');
    const htmlElement = document.documentElement; // The <html> tag

    function applyTheme(theme) {
        if (theme === 'dark') {
            htmlElement.classList.add('dark');
            isDarkMode = true;
            themeToggleIcon.textContent = 'üåô';
            themeToggleTooltip.textContent = 'Cambiar a modo claro';
            localStorage.setItem('theme', 'dark');
        } else {
            htmlElement.classList.remove('dark');
            isDarkMode = false;
            themeToggleIcon.textContent = '‚òÄÔ∏è';
            themeToggleTooltip.textContent = 'Cambiar a modo oscuro';
            localStorage.setItem('theme', 'light');
        }
    }

    function toggleTheme() {
        if (isDarkMode) {
            applyTheme('light');
        } else {
            applyTheme('dark');
        }
    }

    // Event listener for the theme toggle button
    themeToggleBtn.addEventListener('click', toggleTheme);

    // Initialize theme on load
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Apply dark mode if system preference is dark and no theme is saved
            applyTheme('dark');
        } else {
            // Default to light mode if no saved theme and system preference is not dark
            applyTheme('light');
        }
    }
    // --- End Theme Toggle Logic ---

    // --- Pomodoro Timer Logic ---
    const pomodoroBtn = document.getElementById('pomodoroBtn');
    const pomodoroIcon = document.getElementById('pomodoroIcon');
    const pomodoroDisplay = document.getElementById('pomodoroDisplay');
    const pomodoroDropdown = document.getElementById('pomodoroDropdown');
    const pomodoroDropdownItems = document.querySelectorAll('.pomodoro-dropdown-item[data-minutes]');
    const pomodoroResetItem = document.getElementById('pomodoroResetItem');

    // Default work time, but now it can be set by user
    let DEFAULT_WORK_MINUTES = 25; 
    const SHORT_BREAK_MINUTES = 5;

    let pomodoroTimer = {
        interval: null,
        minutes: DEFAULT_WORK_MINUTES,
        seconds: 0,
        isRunning: false,
        sessionType: 'work', // 'work' or 'break'
        workCycles: 0,
        currentWorkDuration: DEFAULT_WORK_MINUTES // Stores the last selected work duration
    };

    function updatePomodoroDisplay() {
        const min = String(pomodoroTimer.minutes).padStart(2, '0');
        const sec = String(pomodoroTimer.seconds).padStart(2, '0');
        pomodoroDisplay.textContent = `${min}:${sec}`;
    }

    function startPomodoro(durationMinutes = pomodoroTimer.currentWorkDuration) {
        if (pomodoroTimer.isRunning && pomodoroTimer.sessionType === 'work') return; // Prevent starting new work timer if one is running

        // If starting a new work session, set its duration
        if (pomodoroTimer.sessionType === 'work' && !pomodoroTimer.isRunning) {
            pomodoroTimer.currentWorkDuration = durationMinutes; // Save the selected duration
            pomodoroTimer.minutes = durationMinutes;
            pomodoroTimer.seconds = 0;
        }

        pomodoroTimer.isRunning = true;
        pomodoroBtn.classList.add('active');
        pomodoroIcon.textContent = '‚è∏Ô∏è'; // Pause icon

        // Hide dropdown if it's open
        pomodoroDropdown.classList.remove('show');


        // Request notification permission if not granted
        if (Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        pomodoroTimer.interval = setInterval(() => {
            if (pomodoroTimer.seconds > 0) {
                pomodoroTimer.seconds--;
            } else if (pomodoroTimer.minutes > 0) {
                pomodoroTimer.minutes--;
                pomodoroTimer.seconds = 59;
            } else {
                // Timer finished
                clearInterval(pomodoroTimer.interval);
                pomodoroTimer.isRunning = false;
                handlePomodoroEnd();
            }
            updatePomodoroDisplay();
        }, 1000);
    }

    function pausePomodoro() {
        clearInterval(pomodoroTimer.interval);
        pomodoroTimer.isRunning = false;
        pomodoroBtn.classList.remove('active');
        pomodoroIcon.textContent = '‚ñ∂Ô∏è'; // Play icon
    }

    function resetPomodoro() {
        pausePomodoro();
        pomodoroTimer.sessionType = 'work';
        pomodoroTimer.minutes = pomodoroTimer.currentWorkDuration; // Reset to the last chosen duration
        pomodoroTimer.seconds = 0;
        pomodoroIcon.textContent = '‚ñ∂Ô∏è'; // Play icon
        updatePomodoroDisplay();
        pomodoroDropdown.classList.remove('show'); // Hide dropdown on reset
    }

    function handlePomodoroEnd() {
        if (pomodoroTimer.sessionType === 'work') {
            // Work session ended
            pomodoroTimer.workCycles++;
            new Notification('¬°Pomodoro Terminado!', {
                body: 'Es hora de un descanso. T√≥mate 5 minutos.',
                icon: 'https://img.icons8.com/color/48/000000/tomato.png' // A tomato icon for notification
            });
            pomodoroTimer.sessionType = 'break';
            pomodoroTimer.minutes = SHORT_BREAK_MINUTES;
            pomodoroTimer.seconds = 0;
            pomodoroIcon.textContent = '‚úÖ'; // Checkmark to indicate completion
            pomodoroBtn.classList.remove('active'); // Remove active state after ending
        } else {
            // Break session ended
            new Notification('¬°Descanso Terminado!', {
                body: 'Es hora de volver al trabajo. Empieza un nuevo Pomodoro.',
                icon: 'https://img.icons8.com/color/48/000000/tomato.png'
            });
            pomodoroTimer.sessionType = 'work';
            pomodoroTimer.minutes = pomodoroTimer.currentWorkDuration; // Reset to the last chosen work duration
            pomodoroTimer.seconds = 0;
            pomodoroIcon.textContent = '‚ñ∂Ô∏è'; // Play icon
            pomodoroBtn.classList.remove('active'); // Remove active state after ending
        }
        updatePomodoroDisplay();
    }

    // Toggle Pomodoro state or show dropdown on button click
    pomodoroBtn.addEventListener('click', (event) => {
        event.stopPropagation(); // Prevent click from bubbling to document and closing dropdown immediately

        if (pomodoroTimer.isRunning) {
            // If timer is running, pause it
            pausePomodoro();
        } else {
            // If timer is not running, toggle dropdown visibility
            pomodoroDropdown.classList.toggle('show');
        }
    });

    // Handle dropdown item clicks
    pomodoroDropdownItems.forEach(item => {
        item.addEventListener('click', (event) => {
            const minutes = parseInt(event.currentTarget.dataset.minutes);
            // Only start if not already running or if it's a new work session
            if (!pomodoroTimer.isRunning || pomodoroTimer.sessionType === 'break' || pomodoroTimer.currentWorkDuration !== minutes) {
                pomodoroTimer.sessionType = 'work'; // Ensure it's a work session
                startPomodoro(minutes);
            }
        });
    });

    // Handle reset item click
    pomodoroResetItem.addEventListener('click', resetPomodoro);


    // Close dropdown if clicked outside
    document.addEventListener('click', (event) => {
        if (!pomodoroDropdown.contains(event.target) && event.target !== pomodoroBtn) {
            pomodoroDropdown.classList.remove('show');
        }
    });

    // --- End Pomodoro Timer Logic ---


    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (lawData) {
            if (e.key === 'ArrowRight') nextSlide();
            if (e.key === 'ArrowLeft') previousSlide();
        }
    });

    // Load initial data and set up intervals
    window.onload = () => {
        initializeTheme(); // Initialize theme first
        displayLaw();
        updateClock();
        setInterval(updateClock, 1000);
        fetchWeather();
        setInterval(fetchWeather, 3600000);
        updatePomodoroDisplay(); // Initialize pomodoro display
    };
  </script>
</body>
</html>
